<link href="/public/app/v4.0/plugins/iCheck/square/blue.css" rel="stylesheet">
<script src="/public/app/v4.0/plugins/iCheck/icheck.min.js"></script>

<div class="margin-b-30 padding-b-30">
    <div class="new_table table flex-table">
        <!-- Encabezado de la tabla -->
        <!--div class="table-header">
            <div class="cell"></div>
            <div class="cell">Variable</div>
            <div class="cell">Valor venta </div>
            <div class="cell">Valor Costo</div>
            <div class="cell">Stock</div>
            <div class="cell"></div>
        </div-->
        <!-- Cuerpo de la tabla -->
        <div class="table-body" id="tableBody">
            <!-- Filas de la tabla -->
            {{#each search_product }}
            <div class="table-row">
                <!-- Detalles -->
                <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
                    <div class="cell-left">

                        <div class="margin-0 ">
                            <input type="checkbox" checked="" class="margin-r-10">
                        </div>

                        <div class="padding-0">
                            <div class="btn-group dropright">
                                <button id="var_btn_{{{doc._id}}}" id="var_btn_{{{doc._id}}}"
                                    onclick="cat_all_variations_get(this)" product_id="{{{doc._id}}}"
                                    variant_id="{{doc.variant_id}}" type="button" data-toggle="dropdown"
                                    aria-expanded="true">
                                    <span id="bg-select-color" class="btn btn-default item-icon">

                                        {{#if doc.picture_min}}
                                        <img src="{{{doc.picture_min}}}"
                                            class="var_img img-card-mini s img-card-catalog-list">
                                        {{else}}

                                        <img src="/public/app/v4.0/dist/img/foto_fondo.png"
                                            class="var_img img-card-mini s img-card-catalog-list">
                                        {{/if}}


                                        <span class="material-icons">arrow_drop_down</span>
                                    </span>
                                </button>
                                <ul class="card-loader dropdown-menu mini pull-left">
                                    <div id="cat_all_variations_get{{{doc._id}}}">
                                        <div class="spinner-box">
                                            <div class="three-quarter-spinner primary"></div>
                                        </div>
                                    </div>
                                </ul>
                            </div>
                        </div>

                        <div class="padding-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div class="padding-0 col-xs-12 col-sm-12 col-md-4 col-lg-4">
                                <h5>{{{doc.name}}}</h5>
                                <h6> 
                                    {{#each doc.tags}}
                                     <span class="text-uppercase margin-r-5 margin-top label bg-blue">{{this}}</span>
                                    {{/each}}
                                </h6>
                            </div>
                            <div class="padding-t-10  col-xs-12 col-sm-12 col-md-8 col-lg-8">

                                <div class="padding-0  padding-b-5 col-xs-6 col-sm-6 col-md-6 col-lg-6">

                                    <div class="btn-group dropright">
                                        <button onclick="catalog_get_menu_price(this)" doc_id="{{{doc._id}}}"
                                            id="variations_set_{{{doc._id}}}" product_id="{{{doc._id}}}"
                                            variant_id="{{doc.variant_id}}" id="catalog_get_menu_price" type="button"
                                            class=" " data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                            <span id="bg-select-color"
                                                class="card_item_selected_price btn btn-transparent">
                                                <div class="round-icon pr">
                                                    <span> {{doc.currency}} </span>
                                                </div>
                                                <label class="counter">
                                                    {{doc.price}}
                                                </label>
                                                <span class="material-icons">arrow_drop_down</span>
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu l pull-right">
                                            <li class="header">Listas de precios</li>

                                            <div id="catalog_new_price_list_{{doc._id}}">
                                                {{#each doc.price_list as | pl |}}
                                                <li>
                                                    <div class="col-xs-5 col-sm-5 col-md-5 col-lg-5">
                                                        <!-- Nombre de lista de precio -->
                                                        {{#each ../../price_list as | l1 |}}
                                                        {{#ifEquals l1.id pl.id }}
                                                        <div id="new_price_list_name_{{id}}" price_list_id="{{id}}"
                                                            price_value="{{value}}">
                                                            {{value}}
                                                        </div>
                                                        {{/ifEquals}}
                                                        {{/each}}
                                                        <!-- FIN Nombre de lista de precio -->
                                                    </div>
                                                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                                                        <!-- Tipo de moneda icono -->
                                                        <span>{{../../currency}}</span>
                                                        <!-- Input para editar precio -->
                                                        <input id="new_price_var_{{id}}" class="form-control"
                                                            type="number" placeholder="Precio" value="{{value}}">

                                                    </div>
                                                    <div class="col-xs-3 col-sm-3 col-md-3 col-lg-3">
                                                        <!-- Boton de guardar cambios -->
                                                        <div class="col-lg-6">
                                                            <button type="button" onclick="edit_price_var(this)"
                                                                id="add_price_var_{{../doc.variant_id}}"
                                                                doc_id="{{{../doc._id}}}" price_id="{{id}}"
                                                                price_value="{{value}}"
                                                                variant_id="{{../doc.variant_id}}" input_id="price_list"
                                                                class="round padding-0  margin-5 dropdown-toggle dropdown-toggle-split btn btn-primary line pull-right "
                                                                aria-haspopup="true" aria-expanded="false">
                                                                <span class="material-icons">add_circle</span>
                                                            </button>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <button onclick="dell_price_var(this)"
                                                                id="dell_price_var_{{id}}"
                                                                class="round padding-0 margin-5  btn btn-primary line"
                                                                doc_id="{{{../doc._id}}}"
                                                                variant_id="{{{../doc.variant_id}}}" price_id="{{id}}"
                                                                price_value="{{value}}" input_id="price_list" href="#"
                                                                title="{{#with ../../ws_lang_data}} {{{m_catalog_edit_delete}}} {{/with}}">
                                                                <span class="material-icons">
                                                                    delete
                                                                </span>
                                                            </button>
                                                        </div>
                                                        <!-- Boton deEliminar -->
                                                    </div>
                                                </li>
                                                {{/each}}
                                            </div>
                                            <div id="edit_price_form{{id}}" role="tabpanel"
                                                aria-labelledby="item-edit-variants" aria-expanded="true"
                                                class="bg-gray-light padding-10 margin-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                                <span class="padding-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                                    Agregar precio
                                                </span>
                                                <div class="padding-0 margin-0  col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                                    <div class="input-group">
                                                        <span class="input-group-addon">
                                                            <span class="material-icons" data-toggle="tooltip"
                                                                data-placement="bottom" title=""
                                                                data-original-title="Agregar precio">
                                                                price_change
                                                            </span>
                                                        </span>
                                                        <select class="form-control md "
                                                            name="price_list_var_{{doc.variant_id}}"
                                                            id="price_list_var_{{doc.variant_id}}">
                                                            {{#each ../price_list }}
                                                            <option value="{{id}}">{{value}}</option>
                                                            {{/each}}
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="padding-0 col-xs-6 col-sm-6 col-md-6 col-lg-6">

                                                    <div class="input-group">
                                                        <input id="new_price_var_{{doc.variant_id}}" class="form-control" type="number" placeholder="Precio"   value="">
                                                        <span class="input-group-addon">
                                                            <button onclick="new_price_var(this)"
                                                                id="add_price_var_{{doc.variant_id}}"
                                                                doc_id="{{{doc._id}}}" variant_id="{{doc.variant_id}}"
                                                                input_id="price_list"
                                                                class="round padding-0  margin-5 dropdown-toggle dropdown-toggle-split btn btn-primary line pull-right "
                                                                data-toggle="dropdown" aria-haspopup="true"
                                                                type="button" aria-expanded="false">
                                                                <span class="material-icons">add_circle</span>
                                                            </button>
                                                        </span>
                                                    </div>

                                                </div>

                                            </div>

                                        </ul>
                                    </div>
                                </div>

                                <div class="padding-0 col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                    <div class="btn-group dropright">
                                        <button onclick="catalog_get_menu_stock(this)" doc_id="{{{doc._id}}}"
                                            id="variations_set_{{{doc._id}}}" product_id="{{{doc._id}}}"
                                            variant_id="{{doc.variant_id}}" type="button" class=" "
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                                            <span id="bg-select-color"
                                                class="card_item_selected_price btn btn-transparent">
                                                <div class="round-icon pr">
                                                    <span class="material-icons">
                                                        trending_up
                                                    </span>
                                                </div>
                                                <span class="hidden-xs hidden-sm">

                                                    {{#with ../ws_lang_data}} {{m_catalog_edit_stock}}: {{/with}}
                                                </span>

                                                <label class="counter">
                                                    {{doc.available_quantity}}
                                                </label>
                                                <span class="material-icons">arrow_drop_down</span>
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu l pull-right">
                                            <li class="header"> {{#with ../ws_lang_data}}
                                                {{m_catalog_edit_stock_update}} {{/with}}</li>
                                            <div id="catalog_new_stock_list_{{doc._id}}">

                                            </div>
                                            <div role="tabpanel" aria-labelledby="item-edit-variants"
                                                aria-expanded="true"
                                                class="bg-gray-light padding-10 margin-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                                <span class="padding-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                                    Agregar Stock
                                                </span>
                                                <div class="padding-0 margin-0  col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                                    <div class="input-group">
                                                        <span class="input-group-addon">
                                                            <span class="material-icons" data-toggle="tooltip"
                                                                data-placement="bottom" title=""
                                                                data-original-title="Agregar precio">
                                                                price_change
                                                            </span>
                                                        </span>
                                                        <input id="new_cost_stock_var_{{doc.variant_id}}"
                                                            class="col-sm-4 form-control" type="number"
                                                            placeholder="Precio de costo" value="">

                                                    </div>
                                                </div>
                                                <div class="padding-0 col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                                    <div class="input-group">
                                                        <input id="add_stock_var_{{doc.variant_id}}"
                                                            class="form-control" type="number" placeholder="Cantidad"
                                                            value="">

                                                        <span class="input-group-addon">
                                                            <button onclick="add_stock_var(this)"
                                                                id="add_stock_var_{{doc.variant_id}}"
                                                                doc_id="{{{doc._id}}}" variant_id="{{doc.variant_id}}"
                                                                input_id="stock_invetary"
                                                                class="round padding-0  margin-5 dropdown-toggle dropdown-toggle-split btn btn-primary line pull-right "
                                                                data-toggle="dropdown" aria-haspopup="true"
                                                                type="button" aria-expanded="false">
                                                                <span class="material-icons">add_circle</span>
                                                            </button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
                <!-- Agregar Precio --><!-- Agregar Stock -->
                <div class=" cell-right col-xs-2 col-sm-2 col-md-2 col-lg-2">
                    <div class="pull-right">
                        {{#userCtx 'catalog' 'edit'}}
                        <div class="Switch" onclick="">
                            <input id="{{{doc._id}}}_{{doc.variant_id}}_status_checkbox" name="switch_variation"
                                {{#ifEquals status.status true }} checked {{/ifEquals}} value="" type="checkbox"
                                doc_id="{{{doc._id}}}" variant_id="{{doc.variant_id}}" input_id="status"
                                onclick="cat_edit_chekbox(this)" />
                            <label for="{{{doc._id}}}_{{doc.variant_id}}_status_checkbox" class="label-primary"></label>
                        </div>

                        <div class="margin-t-5 padding-10 indicator btn-group">
                            <button id="" type="button"
                                class="round padding-0  margin-5 dropdown-toggle dropdown-toggle-split btn btn-default pull-left "
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="material-icons">more_vert</span>
                            </button>
                            <ul class="dropdown-menu pull-right">
                                <li>
                                    <a onclick="catalog_edit_item(this)" doc_id="{{{doc._id}}}"
                                        id="variations_set_{{{doc._id}}}" product_id="{{{doc._id}}}"
                                        variant_id="{{doc.variant_id}}" href="#">
                                        <span class="material-icons">
                                            create
                                        </span>
                                        <span>Editar</span>
                                    </a>
                                </li>
                                <li>
                                    <a onclick="catalog_product_delete(this)" doc_id="{{{doc._id}}}"
                                        variant_id="{{doc.variant_id}}" href="#">
                                        <span class="material-icons">
                                            delete
                                        </span>
                                        <span>Eliminar</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        {{/userCtx}}
                    </div>
                </div>
            </div>
            {{/each}}
            <!-- Repetir para más filas -->
        </div>
    </div>
</div>

<script>


    // Hablilito el icheck para la clase checkbox
    $('.checkbox').iCheck({
        checkboxClass: 'icheckbox_square-blue',
        radioClass: 'iradio_square-blue',
        handle: '',
        increaseArea: '20%' // optional
    });



    // var board_group_deliver = $('input:checkbox[name=board_group_deliver]:checked').val();

    $('input').on('ifChecked', function (event) {
        //  var select = $(this);
        //    var id = select.attr('id');
        //  //   $("#new-board-detail-1").show();
        //    $("#new-board-name").focus();
        ///   var board_type = $('input:radio[name=board-type]:checked').val();
        //   var board_icon = $(this).attr('icon');
        //  var board_bg = $(this).attr('bg-color');
        console.log(board_icon + board_bg)
        /*        if (board_type) {
        /*    $("#board-type-icon").show();
            $("#new-board-step-1").show();
            $("#new-board-name").focus();
            $("#bt-text-icon").attr('icon', board_icon);
            $("#bt-text-icon").children('.material-icons:first').text(board_icon);
            $("#bg-select-color-group").children('.material-icons:first').text(board_icon);
            $("#bg-select-color-group").attr('bg-color', board_bg);
            $("#bg-select-color-group").removeClass().addClass('btn ' + board_bg + ' line');*/
        /*     } else {
            //  $("#board-type-radio-5").hide();
        //    }*/
    });

    $(document).ready(function () {
        // Prevenir el cierre del menú desplegable al hacer clic dentro
        $('.dropdown-menu').on('click', function (e) {
            e.stopPropagation();
        });

        // Opcional: Si tienes elementos específicos en los que quieres prevenir el cierre, puedes ser más específico:
        $('.dropdown-menu select, .dropdown-menu button').on('click', function (e) {
            e.stopPropagation();
        });

        // Si estás usando elementos como botones para disparar alguna acción, asegúrate de que también manejas adecuadamente el evento para que realice lo que necesitas
        $('.dropdown-menu button').on('click', function (e) {
            // Tu código aquí, por ejemplo, para manejar la edición de un precio
            console.log("Botón dentro del menú desplegable presionado.");
        });
    });


    $(document).on('click', '.dropdown-menu-app .dropdown-toggle', function (e) {
        e.preventDefault();
        e.stopPropagation();
        // Toggle del segundo dropdown aquí, si es necesario
        $(this).next('.dropdown-menu').toggle();
    });



    // Actualizo la vista
    async function catalog_get_menu_price(element) {
        try {
            const doc_id = $(element).attr('doc_id');
            const variant_id = $(element).attr('variant_id');
            const doc_id_s = String(doc_id);
            var select_div_id = '#catalog_new_price_list_' + doc_id;

            var doc = await L_catalog_db.get(doc_id_s);
            var price_list = await L_catalog_db.get('price_list');
            var variant = doc.variations.find(response => response.id == variant_id);// Traigo el elemento por la id variant

            const new_variant = {
                variant: variant,
                _id: doc_id,
                ws_lang_data: ws_lang_data,
                user_roles: user_Ctx.userCtx.roles,
                price_list: price_list.price_list,

            }

            //    console.log('new_variant', new_variant);
            // console.log('select_div_id', select_div_id);
            var item_print = await renderHandlebarsTemplate('/public/app/v4.0/dist/hbs/workspace/catalog/product/list/catalog_new_price_get_list.hbs', select_div_id, new_variant);

        } catch (err) {
            console.log(err);
        }
    }
    // Actualizo la vista
    async function catalog_get_menu_stock(element) {
        try {
            const doc_id = $(element).attr('doc_id');
            const variant_id = $(element).attr('variant_id');
            const doc_id_s = String(doc_id);
            var select_div_id = '#catalog_new_stock_list_' + doc_id;

            var doc = await L_catalog_db.get(doc_id_s);
            var price_list = await L_catalog_db.get('price_list');
            var variant = doc.variations.find(response => response.id == variant_id);// Traigo el elemento por la id variant

            // "stock_invetary":

            const new_variant = {
                variant: variant,
                _id: doc_id,
                ws_lang_data: ws_lang_data,
                user_roles: user_Ctx.userCtx.roles,
                price_list: price_list.price_list,
                stock_invetary: variant.stock_invetary,
                available_quantity: variant.available_quantity,
                sold_quantity: variant.sold_quantity,
                limit_discount: variant.limit_discount,

            }

            console.log("new_variant", new_variant);
            console.log('variant', variant);
            var item_print = await renderHandlebarsTemplate('/public/app/v4.0/dist/hbs/workspace/catalog/product/list/catalog_new_stock_get_list.hbs', select_div_id, new_variant);

        } catch (err) {
            console.log(err);
        }
    }







</script>