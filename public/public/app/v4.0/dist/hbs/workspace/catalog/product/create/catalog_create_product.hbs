<!-- CATALOG CREATE NEW PRODUCT TEMPLATE -->

<div class="righ_nav_header">
    <div class="btn-group dopdown">
        <button id="" m_id="" m_t_id="" m_t_name="" type="button"
            class="dropdown-toggle  select-btn btn xl btn-more  dropdown-toggle btn-primary text" data-toggle="dropdown"
            aria-expanded="true">
            <span id="new_type_icon_select" class="material-icons">home_repair_service</span>
            <span id="new_type_value_select" type_order="product"> {{#with ws_lang_data}} {{t_new_product}}
                {{/with}}</span>
            <i class="material-icons">expand_more</i>
        </button>
        <ul class="dropdown-menu pull-left">
            <li class="margin-5">
                <a class="" onclick="new_select_type_order(this)" type_order="product" href="#">
                    <span class="material-icons">inventory_2</span>
                    <span class="type_val"> {{#with ws_lang_data}} {{t_new_product}} {{/with}}</span>
                </a>
            </li>
            <li class="margin-5">
                <a class="" onclick="new_select_type_order(this)" type_order="service" href="#">
                    <span class="material-icons">home_repair_service</span>
                    <span class="type_val">{{#with ws_lang_data}} {{t_new_service}} {{/with}}</span>
                </a>
            </li>
        </ul>
    </div>
    <button id="" type="button" class="left_nav_close btn btn-default right_nav_close pull-right ">
        <span class="material-icons">close</span>
    </button>
</div>
<div class="righ_nav_content">
    <div class="righ_nav_conten_main">
        <form id="new_product_step_1">
            <div class="row padding-t-20 header bg-dark">
                <div style="width: 100%; background-image: url('');" class="parallax img_card">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="padding-0 col-xs-2 col-sm-2 col-md-2 col-lg-2">
                            <div class=" mini-carrousel-new-img ">
                                <div class="mini-card-img-s">
                                    <div class="img">
                                        <a id="minicard_new_product_img" onclick="product_upload_img_pop(this)"
                                            img-charge="" href="#">
                                            <div id="new_img_product_content">
                                                <img src="/public/img/app/foto_fondo.png">
                                            </div>

                                            <span class="material-icons">
                                                add_a_photo
                                            </span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="padding-t-20 col-xs-10 col-sm-10 col-md-10 col-lg-10">
                            <div class="input-group font-size-25">
                                <span class="input-group-addon">
                                    <span class="material-icons" data-toggle="tooltip" data-placement="bottom" title=""
                                        data-original-title="Agregar precio">
                                        drive_file_rename_outline
                                    </span>
                                </span>
                                <input {{#with ws_lang_data}} id="catalog_new_product_name_input" input_id="name"
                                    value="" placeholder="{{m_catalog_edit_name}} "
                                    class="dark_input  form-control font-size-20" type="text" title="" required=""
                                    data-msg-required="Falta completar el nombre" placeholder="{{contact_first_name}}"
                                    name="product_name" {{/with}}>
                            </div>
                        </div>
                    </div>
                    <!-- TAGS MAIN -->
                    <div class="padding-t-10 margin-t-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="chips_main">
                            <span class="icon material-icons" data-toggle="tooltip" data-placement="bottom" title=""
                                data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_tags}}} {{/with}}">
                                tag
                            </span>
                            <div id="new_prod_tag_main" class="chips_items_main">

                            </div>
                            <input doc_id="" input_id="tags" class="chips_input form-control"
                                placeholder="{{#with ws_lang_data}} {{m_catalog_edit_tags}} {{/with}}" name="keywords"
                                type="text" onkeypress="catalog_add_new_tag_press(event,this)" style="">
                        </div>
                    </div>

                </div>
            </div>
            <div id="edit-item-description-body" class="">
                <div class="panel-body">
                    <div class="row">
                        <!--- Categorias  -->
                        <div class="padding-0 margin-t-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div class="input-group flex">
                                <span class="input-group-addon">
                                    <div class="btn-group dropright">
                                        <button id="" type="button"
                                            class=" margin-5 dropdown-toggle dropdown-toggle-split btn btn-default pull-right "
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="material-icons" data-toggle="tooltip" data-placement="bottom"
                                                data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_category}}} {{/with}}">
                                                category
                                            </span>

                                            <span id="catalog_select_cat_tittle"> {{#with ws_lang_data}}
                                                {{{m_catalog_edit_category}}} {{/with}} <span>
                                        </button>

                                        <ul class="dropdown-menu open-right  m">
                                            <!--ul class="dropdown-menu m pull-right"></ul-->
                                            <li class="header">
                                                <span class="material-icons" data-toggle="tooltip"
                                                    data-placement="bottom"
                                                    data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_category}}} {{/with}}">
                                                    category
                                                </span>
                                                {{#with ws_lang_data}} {{{m_catalog_edit_category}}} {{/with}}
                                                <span class="material-icons">arrow_right</span>
                                                <span id="catalog_select_cat_value"></span>
                                            </li>

                                            <li>
                                                <div>
                                                    <input input_id="catalog_cat_input" id="catalog_new_cat_input"
                                                        class="form-control"
                                                        onkeypress="catalog_search_new_prod_cat(event,this)" type="text"
                                                        doc_id="{{_id }}"
                                                        placeholder="{{#with ws_lang_data}} {{{m_catalog_edit_add}}} {{{m_catalog_edit_new}}} {{{m_catalog_edit_category}}} {{/with}} ">

                                                </div>
                                            </li>
                                            <div id="catalog_select_new_cat_list">
                                                {{#each category_list/category_list }}
                                                <li onclick='catalog_select_new_cat(this)' item_value_id="{{id}}"
                                                    item_value="{{value}}" item_id="category">
                                                    <div class="dropdown-item">
                                                        <a href="#">
                                                            {{value}}
                                                        </a>
                                                        <button>
                                                            <span doc_id="" value="{{value}}" class="material-icons"
                                                                onclick='catalog_dell_cat(this)'>delete</span>
                                                        </button>
                                                    </div>
                                                </li>
                                                {{/each}}
                                            </div>
                                        </ul>

                                    </div>
                                </span>
                            </div>
                            <!--- MARCAS  -->
                            <div class="input-group flex">
                                <span class="input-group-addon">
                                    <div class="btn-group dropright">

                                        <button id="" type="button"
                                            class=" margin-5 dropdown-toggle dropdown-toggle-split btn btn-default pull-right "
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="material-icons" data-toggle="tooltip" data-placement="bottom"
                                                data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_trade}}} {{/with}}">
                                                grid_view
                                            </span>

                                            <span id="catalog_select_trade_tittle">{{#with
                                                ws_lang_data}}{{{m_catalog_edit_trade}}} {{/with}} <span>
                                        </button>

                                        <ul class="dropdown-menu open-right m">
                                            <!--ul class="dropdown-menu m pull-right"></ul-->
                                            <li class="header">
                                                <span class="material-icons" data-toggle="tooltip"
                                                    data-placement="bottom"
                                                    data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_trade}}} {{/with}}">
                                                    grid_view
                                                </span>
                                                {{#with ws_lang_data}} {{{m_catalog_edit_trade}}} {{/with}}
                                                <span class="material-icons">arrow_right</span>
                                                <span id="catalog_select_trade_value"></span>
                                            </li>

                                            <li>
                                                <div>
                                                    <input id="catalog_new_trade_input"
                                                        onkeypress="catalog_search_new_pro_trade(event,this)"
                                                        input_id="catalog_trade_input" class="form-control" type="text"
                                                        placeholder="{{#with ws_lang_data}} {{{m_catalog_edit_add}}} {{{m_catalog_edit_new}}} {{{m_catalog_edit_category}}} {{/with}} ">

                                                </div>
                                            </li>
                                            <div id="catalog_select_new_trade_list">
                                                {{#each trade_list/trade_list }}
                                                <li onclick='catalog_select_new_trade(this)' item_value_id="{{id}}"
                                                    item_value="{{value}}" item_id="trade">
                                                    <div class="dropdown-item">
                                                        <a href="#">
                                                            {{value}}
                                                        </a>
                                                        {{#userCtx 'catalog' 'admin'}}
                                                        <button>
                                                            <span doc_id="" value="{{value}}" class="material-icons"
                                                                onclick='catalog_dell_trade(this)'>delete</span>
                                                        </button>
                                                        {{/userCtx }}

                                                    </div>
                                                </li>
                                                {{/each}}
                                            </div>
                                        </ul>

                                    </div>
                                </span>
                            </div>
                            <!--- MODELO  -->
                            <div class="input-group flex">
                                <span class="input-group-addon">
                                    <div class="btn-group dropleft">
                                        <button id="" type="button"
                                            class=" margin-5 dropdown-toggle dropdown-toggle-split btn btn-default pull-left "
                                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <span class="material-icons" data-toggle="tooltip" data-placement="bottom"
                                                data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_model}}} {{/with}}">
                                                flip_to_front
                                            </span>
                                            <span id="catalog_select_model_tittle">{{#with
                                                ws_lang_data}}{{{m_catalog_edit_model}}} {{/with}} <span>
                                        </button>
                                        <ul class="dropdown-menu m open-left">
                                            <li class="header">
                                                <span class="material-icons" data-toggle="tooltip"
                                                    data-placement="bottom"
                                                    data-original-title="{{#with ws_lang_data}} {{{m_catalog_edit_model}}} {{/with}}">
                                                    flip_to_front
                                                </span>
                                                {{#with ws_lang_data}} {{{m_catalog_edit_model}}} {{/with}}
                                                <span class="material-icons">arrow_right</span>
                                                <span id="catalog_select_model_value"></span>
                                            </li>
                                            <li>
                                                <div>
                                                    <input id="catalog_new_model_input" input_id="catalog_model_input"
                                                        onkeypress="catalog_search_model(event,this)"
                                                        class="form-control" type="text"
                                                        placeholder="{{#with ws_lang_data}} {{{m_catalog_edit_add}}} {{{m_catalog_edit_new}}} {{{m_catalog_edit_model}}} {{/with}} ">

                                                </div>
                                            </li>
                                            <div id="catalog_select_new_model_list">
                                                {{#each model_list/model_list }}
                                                <li onclick='catalog_select_new_model(this)' item_value_id="{{id}}"
                                                    item_value="{{value}}" item_id="model">
                                                    <div class="dropdown-item">
                                                        <a href="#">
                                                            {{value}}
                                                        </a>
                                                        {{#userCtx 'catalog' 'admin'}}
                                                        <button>
                                                            <span doc_id="" value="{{value}}" class="material-icons"
                                                                onclick='catalog_dell_model(this)'>delete</span>
                                                        </button>
                                                        {{/userCtx }}

                                                    </div>
                                                </li>
                                                {{/each}}
                                            </div>


                                        </ul>
                                    </div>
                                </span>
                            </div>
                        </div>

                        <div class="input-group padding-t-20 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <span class="input-group-addon">
                                <span class="material-icons">
                                    qr_code
                                </span>
                            </span>
                            <input id="new_sku" class="form-control" type="text" placeholder="Codigo universal SKU"
                                value="">
                        </div>

                        <!--- AGREGR STOCK -->
                        <div class="bg-gray-light padding-20 margin-t-10 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div class="padding-0 col-xs-6 col-sm-6 col-md-6 col-lg-6">

                                <h4 class="tittle_input"><strong>Cantidad</strong></h4>
                                <div class="input-group font-size-25">
                                    <span class="input-group-addon">
                                        <span class="material-icons" data-toggle="tooltip" data-placement="bottom"
                                            title="" data-original-title="Agregar precio">
                                            inventory_2
                                        </span>
                                    </span>
                                    <div class="input-group">
                                        <input id="add_stock_unit" class="form-control font-size-25" type="number"
                                            placeholder="{{#with ws_lang_data}} {{{m_catalog_add_stock}}} {{/with}}"
                                            value="">
                                    </div>
                                </div>

                            </div>
                            <div class="padding-0 margin-0  col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                <h4 class="tittle_input"><strong>Precio de costo</strong></h4>
                                <div class="input-group ">
                                    <span class="input-group-addon font-size-25">
                                        {{#with currency }}
                                        {{value}}
                                        {{/with}}
                                    </span>
                                    <input onkeyup="updatePrice(this)" id="new_cost_stock"
                                        class="col-sm-4 form-control font-size-25" type="number"
                                        placeholder="{{#with ws_lang_data}} {{{m_catalog_add_stock_cost}}} {{/with}}"
                                        value="">
                                </div>
                            </div>
                        </div>

                        <!--- PRECIO -->
                        <div class="bg-gray-light padding-20 margin-t-10 col-xs-12 col-sm-12 col-md-12 col-lg-12">


                            <div class="padding-10 col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                <h4 class="tittle_input"><strong>Lista de precios</strong></h4>

                                <div class="input-group font-size-25">
                                    <span class="input-group-addon">
                                        <span class="material-icons" data-toggle="tooltip" data-placement="bottom"
                                            title="" data-original-title="Agregar precio">
                                            price_change
                                        </span>
                                    </span>
                                    <select class="form-control  md " name="new_price_list_var_select"
                                        id="new_price_list_var_select">
                                        {{#each price_list }}
                                        <option value="{{id}}">{{value}}</option>
                                        {{/each}}
                                    </select>
                                </div>
                            </div>
                            <div class="padding-10 col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                <h4 class="tittle_input"><strong>Impuesto</strong></h4>

                                <div class="input-group font-size-25">
                                    <span class="input-group-addon">
                                        <span class="material-icons" data-toggle="tooltip" data-placement="bottom"
                                            title="" data-original-title="Agregar precio">
                                            price_change
                                        </span>
                                    </span>
                                    <select class="form-control  md " name="new_tax_list" id="new_tax_list_var_select">
                                        {{#with tax_list}}
                                        {{#each tax }}
                                        <option value="{{id}}">{{name}} ( {{value}} )</option>
                                        {{/each}}
                                        {{/with}}
                                    </select>
                                </div>
                            </div>
                            <div class="padding-10 col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                <h4 class="tittle_input"><strong>Calcular ganancia</strong></h4>
                                <div class="input-group">
                                    <span class="input-group-addon font-size-25 padding-0">
                                        <div class="Switch" onclick="">
                                            <input id="new_porcent_checkbox" name="new_porcent" value=""
                                                type="checkbox" onclick="new_porcent_switch(this)" />
                                            <label for="new_porcent_checkbox" class="label-primary"></label>
                                        </div>
                                    </span>
                                    <span class="input-group-addon font-size-25 padding-0">
                                        %
                                    </span>
                                    <input onkeyup="new_porcent_price(this)" id="new_porcent_value"
                                        class="form-control font-size-25" type="number"
                                        placeholder="{{#with ws_lang_data}} {{{m_catalog_add_stock_profit}}} {{/with}}"
                                        value="">
                                </div>
                            </div>
                            <div class="padding-10 col-xs-6 col-sm-6 col-md-6 col-lg-6">
                                <h4 class="tittle_input"><strong>Precio de venta</strong></h4>
                                <div class="input-group">
                                    <span class="input-group-addon font-size-25">
                                        {{#with currency }}
                                        {{value}}
                                        {{/with}}
                                    </span>
                                    <input id="new_price" class="form-control font-size-25" type="number"
                                        placeholder="{{#with ws_lang_data}} {{{m_catalog_add_stock_sale}}} {{/with}}"
                                        value="">
                                </div>
                            </div>

                        </div>

                        <button onclick="catalog_new_item_new_price(this)" doc_id="" variant_id="" type="button"
                            class="pull-right margin-20 btn btn-primary">
                            {{#with ws_lang_data}} {{{m_catalog_add_stock_price_list}}}{{/with}}
                        </button>

                    </div>
                </div>
            </div>

        </form>
    </div>
</div>
<!--- MAIN VARIACIONES imprimo el catalog_new_variaton -->
<div id="create_prod_new_variations_main" class="margin-0 padding-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
</div>


<!--- FOOTER BOTONES  -->
<div class="righ_nav_footer_main" id="cart_footer">
    <div class="right_nav_footer text-center ">
        <!--button type="button" class="btn btn-primary"><span class="material-icons"> print </span> Imprimir </button-->
        {{#userCtx 'catalog' 'edit'}}
        <button onclick="catalog_new_product(this)" doc_id="" variant_id="" type="button"
            class="btn btn-primary btn-full-with">
            <!--span id="preloader_up_pic" style="display:" class="material-icons material-icon-spinner">sync</span-->
            <span id="preloader_finish" class="material-icons"> more</span>
            {{#with ws_lang_data}} {{{t_new_product}}}{{/with}}
        </button>
        {{/userCtx}}
    </div>
</div>
<!--script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.0.7/compressor.min.js"></script-->
<link href="/public/app/v4.0/plugins/iCheck/square/blue.css" rel="stylesheet">
<script src="/public/app/v4.0/plugins/iCheck/icheck.min.js"></script>
<script>

    /// NUEVO PRODUCTO ///// 
    var selectedFile; // Variable global para almacenar el archivo seleccionado

    function new_select_type_order(opcion) {
        const type_order_select = opcion.getAttribute('type_order');
        const type_order_icon_select = opcion.querySelector('.material-icons').textContent;
        const type_order_name_select = opcion.querySelector('.type_val').textContent;
        $('#new_type_icon_select').html(type_order_icon_select);
        $('#new_type_value_select').attr('type_order', type_order_select);
        $('#new_type_value_select').html(type_order_name_select);
    }



    /// SUBIR IMAGEN
    async function compressAndUploadImage() {

        const fileInput = document.getElementById('fileInput');
        const file = fileInput;

        if (!file) {
            console.error("No se seleccionó ninguna imagen.");
            return;
        }

        try {
            // Crear una instancia de ImageCompressor
            const imageCompressor = new ImageCompressor();

            // Comprimir la imagen usando la biblioteca ImageCompressor
            const compressedFile = await imageCompressor.compress(file, {
                quality: 0.8, // Calidad de compresión (rango del 0 al 1)
                maxWidth: 500, // Ancho máximo deseado después de la compresión
                maxHeight: 500, // Alto máximo deseado después de la compresión
            });

            // Crear un objeto Blob con la imagen comprimida y el mismo formato original
            const compressedBlob = new Blob([compressedFile], { type: file.type });

            // Crear un objeto File con el Blob comprimido y el mismo nombre que el archivo original
            const compressedImage = new File([compressedBlob], file.name, {
                lastModified: file.lastModified,
                type: file.type,
            });

            // Ahora puedes enviar la imagen comprimida al servidor o realizar otras operaciones
            // Por ejemplo, puedes enviarla mediante una solicitud AJAX o utilizar un formulario para subir la imagen.

            // Ejemplo de solicitud AJAX (con Fetch API)
            const formData = new FormData();
            formData.append("image", compressedImage);

            return compressedImage;
            /*
              const response = await fetch("tu_url_de_servidor", {
                method: "POST",
                body: formData,
              });
        
              if (response.ok) {
                console.log("Imagen subida exitosamente.");
              } else {
                console.error("Error al subir la imagen:", response.statusText);
              }
        */

        } catch (error) {
            console.error("Error al comprimir la imagen:", error);
        }
    }
    // Función para cargar la imagen previa
    async function previewImage(event) {

        try {
            const fileInput = event.target;
            if (fileInput.files && fileInput.files[0]) {
                selectedFile = fileInput.files[0]; // Guardar el archivo seleccionado en la variable global
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#minicard_new_product_img').attr('img-charge', true);
                    $("#previewContainer").html("<img id='new_product_img_card' src='" + e.target.result + "'alt=''>");
                    $("#new_img_product_content").html("<img id='new_product_img_card' src='" + e.target.result + "'alt=''>");
                    $('#delluploadImage_btn').show();
                };
                reader.readAsDataURL(selectedFile);
            }

        }
        catch (err) {
            console.log(err)
        }

    }

    function delluploadImage() {
        $('#new_product_img_card').remove();
        $('#delluploadImage_btn').hide();
        $("#previewContainer").html("<img id='new_product_img_card' class='preview-image' src='/public/img/app/foto_fondo.png'alt=''>");
        $("#new_img_product_content").html("<img id='new_product_img_card' src='/public/img/app/foto_fondo.png'alt=''>");
    }

    async function uploadImage(doc_id, variant_id) {
        const input_id = 'pictures';
        //  console.log('selectedFile', selectedFile, 'ID', doc_id, 'Varian ID', variant_id)
        if (!selectedFile) { }
        const formData = new FormData();
        formData.append('userfile', selectedFile);
        try {
            const response = await fetch('img_product_upload', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            /// Actualizo el linck del docuemento 
            var doc_id_s = String(doc_id);
            var doc = await L_catalog_db.get(doc_id_s);
            //Busco dentro de las variables
            if (variant_id) {
                var item = doc.variations.find(response => response.id == variant_id);// Traigo el elemento por la id variant
                var value = item[input_id]; //Traigo el ojeto especifico 
                value[0] = {
                    max: data.new_name,
                    min: data.new_name
                };
                //Edito el valor del value por el valor nuevo
                if (item) {
                    L_catalog_db.put({
                        _id: doc._id,
                        _rev: doc._rev,
                        ...doc,
                    });
                    $("#img-card-" + variant_id + "-" + doc._id).css("background-image", "url('" + data.new_name + "')");
                    $("#mini-card-img-card-" + variant_id + "-" + doc._id).attr("src", data.new_name);
                    $("#new_img_product_content").html("<img id='new_product_img_card' src='" + data.new_name + "'alt=''>");
                }
            }
        } catch (error) {
            console.error(error);
            preloader.style.display = 'none';
        }
    }

    async function catalog_new_product(element) {
        // Recoge los mensajes desde los atributos de los campos
        try {
            //NOMBRE
            const new_doc_name = $("#catalog_new_product_name_input").val(); //Nombre
            const new_product_name_error = $("#catalog_new_product_name_input").attr('data-msg-required');
            //TIPO 
            const type = $('#new_type_value_select').attr('type_order'); //Tipo
            var doc_id_s = String(new_doc_name); //Combierto el id del doc en un string
            //NEW ID
            var new_doc_id_random = Math.floor(Math.random() * (+'1000000' - +'1')) + +'1';
            let textoSinEspacios = new_doc_name.replace(/\s+/g, '-');
            const new_doc_id = textoSinEspacios + "-" + new_doc_id_random;
            const new_doc_time = new Date(); //Id del documento a editar
            const new_doc_author = user_Ctx.userCtx.name; //Id del documento a editar
            const new_doc_workspace_id = ws_id; //Id del documento a editar
            // Seleccionar el elemento div con el id "new_prod_tag_main" y la clase "chips_items_main"
            const divTags = document.querySelector('div#new_prod_tag_main.chips_items_main');
            // CATEGORIA
            const new_doc_cat_value = $('#catalog_select_cat_value').html();
            const new_doc_cat_id = $('#catalog_select_cat_value').attr('catalog_select_cat_value');
            const category = { id: new_doc_cat_id, value: new_doc_cat_value };

            // MARCA
            const new_doc_trade_value = $('#catalog_select_trade_value').html();
            const new_doc_trade_id = $('#catalog_select_trade_value').attr('catalog_select_trade_value');
            const trade = { id: new_doc_trade_id, value: new_doc_trade_value };

            // MODELO
            const new_doc_model_value = $('#catalog_select_model_value').html();
            const new_doc_model_id = $('#catalog_select_model_value').attr('catalog_select_model_value');
            const model = { id: new_doc_model_id, value: new_doc_model_value };

            // PRECIO COSTO
            const new_cost_stock = $('#new_cost_stock').val();
            const new_stock_unit = $('#add_stock_unit').val(); //Stock unidades
            const new_porcent_checkbox = $('#new_porcent_checkbox').val(); //witch
            const new_porcent_value = $('#new_porcent_value').val();//Porcentaje de ganancia
            const new_price = $('#new_price').val(); //Precio venta

            // IMPUESTOS
            const tax_doc = await L_catalog_db.get('tax_list');
            const new_tax_list_id = $('#new_tax_list_var_select').val();
            const tax = tax_doc.tax.find(response => response.id == new_tax_list_id);// busco y traigo todos los datos del id q seleccione 

            // MONEDA
            const currency_doc = await L_catalog_db.get('currency_list');
            const currency_default = currency_doc['currency_default'];

            // SKU
            const new_sku = $('#new_sku').val();

            // PRECIO
            const price_doc = await L_catalog_db.get('price_list'); //Traigo el doc 
            const new_price_list_id = $('#new_price_list_var_select').val();    //Traigo el id seleccionado
            const price_list_arr = price_doc.price_list.find(response => response.id == new_price_list_id);// busco y traigo todos los datos del id q seleccione 
            const price_list = [
                {
                    id: price_list_arr.id,
                    value: new_price,
                    value_porcent: new_porcent_value,
                    value_swich: new_porcent_checkbox,
                    currency: currency_default
                }
            ];

            /// NEW STOCK
            const new_radom_id = Math.floor(Math.random() * (+'1000000' - +'1')) + +'1';
            const stock_inventary = [
                {
                    id: new_radom_id,
                    create: new_doc_time,
                    in_datetime: new_doc_time,
                    update_datetime: new_doc_time,
                    updateUser: new_doc_author,
                    type: 'in',
                    in_stock: new_stock_unit,
                    out_stock: 0,
                    real_stock: new_stock_unit,
                    cost_price: new_cost_stock,
                    currency: currency_default,
                    location_id: 1
                }
            ];
            // TAGS
            const textoTags = [];
            divTags.childNodes.forEach(childNode => {
                if (childNode.nodeType === Node.ELEMENT_NODE) {
                    const span = childNode.querySelector('span.chips_text');
                    if (span) {
                        textoTags.push(span.textContent);
                    }
                }
            });
            const new_doc_tags = textoTags;




            // Define las reglas y mensajes de validación en una sola llamada a validate
            $("#new_product_step_1").validate({
                ignore: [],
                rules: {
                    product_name: {
                        required: true
                    }
                    /*,
                    product_count: {
                        required: true
                    },
                     price_cost: {
                        required: true
                    },
                    price_sell: {
                        required: true
                    },
                    add_stock_unit*/

                },
                messages: {
                    product_name: {
                        required: new_product_name_error
                    }

                }
            });

            // Solo si el formulario es válido, recoger los datos y enviarlos
            if ($("#new_product_step_1").valid()) {
                const new_variant_id = Math.floor(Math.random() * (+'1000' - +'1')) + +'1';
                // Documento variable template
                var variations = [{
                    "id": new_variant_id,
                    currency: currency_default,
                    tax,
                    price_list,
                    stock_inventary,
                    "sold_quantity": 0,
                    "available_quantity": 0,
                    "limit_discount": 0,
                    "status": {
                        "status": true,
                        "value": ""
                    },
                    "sku": new_sku,
                    "pictures": [
                        {
                            "max": "/public/app/v4.0/dist/img/catalog/product-thumbnail.png",
                            "min": "/public/app/v4.0/dist/img/catalog/product-thumbnail.png"
                        }
                    ],

                    "attribute_combinations": [
                        {
                            "id": "COLOR",
                            "id_name": "Color",
                            "name": "Roja",
                            "value": "EF5350"
                        },
                        {
                            "id": "SIZE",
                            "id_name": "Talle",
                            "name": "Medium",
                            "value": "M"
                        },
                        {
                            "id": "WEIGHT",
                            "id_name": "Peso",
                            "unit": "Kg",
                            "name": "Peso",
                            "value": 10
                        },
                        {
                            "id": "MEASURES",
                            "id_name": "Dimension",
                            "name": "Dimension",
                            "unit": "cm",
                            "width": 100,
                            "height": 50,
                            "value": "100cm x 50cm"
                        }
                    ],
                    "description": {
                        "status": true,
                        "value": "Nueva Descripcion"
                    }
                }];
                // Documento template producto
                var response = await L_catalog_db.put({
                    _id: new_doc_id,
                    "name": new_doc_name,
                    "author": new_doc_author,
                    "start_time": new_doc_time,
                    "workspace_id": new_doc_workspace_id,
                    "status": "active",
                    "condition": "new",
                    "type": type,
                    "tags": new_doc_tags,
                    category,
                    trade,
                    model,
                    "cost_price": [
                        {
                            id: 1,
                            value: 1000,
                            id_stock_invetary: 311
                        }
                    ],
                    "permalink": null,
                    "descriptions": [
                        null
                    ],
                    variations,
                    "last_update_at": [
                        {
                            "username": new_doc_author,
                            "datetime": new_doc_time
                        }
                    ]
                });
                if (response) {
                    //Imprimo el item en la pantalla 
                    console.log(response)
                    var product_doc = await L_catalog_db.get(new_doc_id);
                    var new_category_list = await L_catalog_db.get('category_list');
                    var new_trade_list = await L_catalog_db.get('trade_list');
                    var new_model_list = await L_catalog_db.get('model_list');
                    var attributes = await L_catalog_db.get('attributes');
                    var user_roles_permisions = user_Ctx.userCtx.roles;

                    var product_doc_array = {
                        product_doc: product_doc,
                        price_list: price_doc.price_list,
                        currency_list: currency_default,
                        ws_lang_data: ws_lang_data,
                        user_roles: user_roles_permisions,
                        category_list: new_category_list,
                        trade_list: new_trade_list,
                        model_list: new_model_list,
                        attributes_list: attributes
                    }
                    let up_img = await uploadImage(new_doc_id, new_variant_id);
                    console.log('up_img', up_img);
                    console.log('product_doc_array', product_doc_array);

                    let right_main = $('.righ_nav_content').html('<div class="cart_items_trash"><span class="material-icons xl">collections</span> <br> <span class="cart_items_title"> Se creo el producto con exito!</span></div>');
                    // renderHandlebarsTemplate('/public/app/v4.0/dist/hbs/workspace/catalog/product/create/catalog_create_variation.hbs', '#create_prod_new_variations_main', product_doc_array);

                    Snackbar.show({
                        text: 'Se creo con exito!' + new_doc_id,
                        actionText: 'ok',
                        pos: 'bottom-right',
                        actionTextColor: "#0575e6",
                    });

                    createCookie('left_nav_open_ws_' + ws_id, false), 30;// seteo la ventana abierta en la cockie
                    $('#right_main').removeClass('move-right');
                    var m_url = '?type=catalog&?t=create_item&?id=' + new_doc_id + '&?v=' + new_variant_id;
                    history.replaceState(null, null, m_url) //Cargo la nueva url en la barra de navegacion 
                } else {
                    $(element).css("color", "red");
                }

                return true
            } else {
                return false;
            }


        } catch (err) {
            console.log(err);
        }
    }

    // ACTUALIZAR PRECIOS 


    function new_porcent_priceOld_no() {
        var new_cost_stock = $('#new_cost_stock').val();
        var new_porcent_checkbox = $('#new_porcent_checkbox').val();
        var new_porcent_value = $('#new_porcent_value').val();
        var new_price = $('#new_price').val();
        const cost = parseFloat(new_cost_stock);
        const porcent = parseFloat(new_porcent_value);
       // console.log('new_porcent_checkbox', new_porcent_checkbox);
       // console.log('new_cost_stock', new_cost_stock);
       /// console.log('new_porcent_value', new_porcent_value);
       // console.log('new_price', new_price);
        // Calcular el precio de venta basado en el porcentaje y el costo
        const new_price_value = cost + (cost * (porcent / 100));
        //priceInput.value = price.toFixed(2);
        // priceInput.disabled = true;
        // console.log('New_price_value',new_price_value);
        var new_price = $('#new_price').val(parseFloat(new_price_value));
        if (new_porcent_checkbox) {

        } else {
            //  priceInput.disabled = false;
        }

    }
function new_porcent_price() {
    var new_cost_stock = $('#new_cost_stock').val();
    var new_porcent_checkbox = $('#new_porcent_checkbox').is(':checked');
    var new_porcent_value = $('#new_porcent_value').val();
    var new_price_input = $('#new_price');

    const cost = parseFloat(new_cost_stock);
    const porcent = parseFloat(new_porcent_value);

    // Calcular el precio de venta basado en el porcentaje y el costo
    const new_price_value = cost + (cost * (porcent / 100));
    new_price_input.val(new_price_value.toFixed(2));

    if (new_porcent_checkbox) {
        new_price_input.prop('readonly', true);
    } else {
        new_price_input.prop('readonly', false);
    }
}

 function new_porcent_switch() {
    var new_cost_stock = $('#new_cost_stock').val();
    var new_porcent_checkbox = $('#new_porcent_checkbox').is(':checked');
    var new_porcent_value = $('#new_porcent_value');
    var new_price_input = $('#new_price');
    if (new_porcent_checkbox) {
        new_price_input.prop('readonly', true); // Deshabilita la edición del input del precio de venta
        new_porcent_value.prop('disabled', false); // Habilita la edición del input del porcentaje
         new_porcent_price();
    } else {
        // Si el interruptor está desactivado, permite la edición del input del precio y deshabilita el input del porcentaje.
        new_price_input.prop('readonly', false); // Habilita la edición del input del precio de venta
        new_porcent_value.prop('disabled', true); // Deshabilita la edición del input del porcentaje
    }
    }

function updatePrice(){
    var new_porcent_checkbox = $('#new_porcent_checkbox').is(':checked');
    if (new_porcent_checkbox) {
        new_porcent_price()
    } else {

    }
}

$('#new_porcent_checkbox').click(function () {
        // Si esta seleccionado (si la propiedad checked es igual a true)
        if ($(this).prop('checked')) {
            $('input.control_cash').iCheck('enable');
        } else {
            // Deselecciona cada input que tenga la clase .checar
            $('input.control_cash').iCheck('uncheck');
            $('input.control_cash').iCheck('disable');
        }
    });




</script>