<!-- Cart Nav module -->



<div class="righ_nav_header {{#with ws_info}}  {{{workspace_color}}}  {{/with}}">

    <div class="margin-0 padding-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <h3 class="margin-0 padding-10">
            <span class="material-icons">
                qr_code
            </span>
            {{#with order_doc}} {{order_id}} {{/with}}
            <button id="" type="button" class="left_nav_close btn btn-default right_nav_close pull-right ">
                <span class="material-icons">close</span>
            </button>
        </h3>
    </div>

    <div class="padding-5">
        <div class="btn-group dopdown">
            {{#each board_group_doc.board_group}}
            {{#ifEquals id ../group_id }}
            <button type="button" class="dropdown-toggle select-btn xl btn-more btn btn-default" data-toggle="dropdown"
                aria-expanded="true">
                <div class="round-icon xd {{color}}">
                    <span class="material-icons">task_alt</span>
                </div>
                <span class="">{{name}}</span>
                <i class="material-icons">expand_more</i>
            </button>
            <ul class="dropdown-menu pull-left">
                {{#each ../board_group_doc.board_group}}
                <li class="margin-5">
                    <a class="" onclick="order_edit_group_select(this)" order_id="{{{../../order_id}}}"
                        group_id="{{{id}}}" href="#">
                        <div class="round-icon xd {{color}}">
                            <span class="material-icons">task_alt</span>
                        </div>
                        <span class="this_m_t_name">{{name}}</span>
                    </a>
                </li>
                {{/each}}
            </ul>
            {{/ifEquals}}
            {{/each}}
        </div>
    </div>

    <div class="padding-5">
            {{#with order_doc.customer}}
            
                <button onclick="edit_order_contact(this)" {{#with ../../order_doc}} doc_rev="{{_rev}}" doc_id="{{_id}}"{{/with}} type="button" class="btn btn-default">
                    <span class="material-icons">manage_accounts </span>
                    <span class="hidden-xs hidden-sm">{{first_name}}</span>
                </button>

            <div class="btn-group dopdown">
                <!-- Con dopdown baja el poper-->
                <button class="btn xs btn-more  dropdown-toggle" type="button" data-toggle="dropdown">
                    <h5>
                        <div class="round-icon pr xd"><span>p</span></div>
                        {{first_name}}
                    </h5>
                </button>
                <ul class="dropdown-menu card pull-left">
                    <!-- Con pull-right mueve para la derecha o hizquierda el poper-->
                    <div class="body">
                        <li class="header">
                            Contacto
                        </li>
                        <li>
                            <h4 class="">
                                <span class="material-icons">
                                    account_circle
                                </span> 
                                
                                {{first_name}}
                            </h4>
                        </li>
                        <li>
                            <h4 class="">
                                <span class="material-icons">
                                    {{email}}
                                </span>
                            </h4>
                        </li>
                        <li>
                            <h4 class="">
                                <span class="material-icons">mobile_screen_share</span>
                                 {{phone}}
                            </h4>
                        </li>
                        <li>
                            <a class="btn btn-success md" target="_blank" rel="nofollow"
                                href="https://api.whatsapp.com/send?phone=54+5411{{phone}}&amp;text= Hola te contactamos ">
                                <span class="material-icons">mobile_screen_share</span>
                                Enviar whatsapp
                            </a>
                        </li>
                        <li role="separator" class="divider"></li>
                        <li>
                            <h4 class="">
                                <span class="material-icons">
                                    home
                                </span>
                                {{phone}} <br>
                            </h4>
                        </li>
                    </div>
                    <li class="">
                        <a class="btn btn-primary md" target="_blank" href="https://www.google.com/maps/search/?api=1&amp;query={{phone}}+++">
                            <span class="material-icons">directions</span>
                            Indicaciones
                        </a>
                    </li>
                </ul>
            </div>
            {{/with}}

            {{#with phone}}
            <button onclick="" class="btn btn-default">
                <span class="material-icons"> perm_phone_msg</span>{{this}}
            </button>
            {{/with}}
        {{/with}}
    </div>

    <div class="padding-5">

        {{#with order_doc.customer}}
            

        <span class="left">
            
        </span>


        <button onclick="edit_order_contact(this)" {{#with ../../order_doc}} doc_rev="{{_rev}}" doc_id="{{_id}}"
            {{/with}} type="button" class="btn btn-default">
            <span class="material-icons">manage_accounts </span>
            <span class="hidden-xs hidden-sm">{{this}}</span>
        </button>
        {{/with}}
        {{#with phone}}
        <button onclick="" class="btn btn-default">
            <span class="material-icons"> perm_phone_msg</span>{{this}}
        </button>
        {{/with}}
        {{/with}}
    </div>



</div>

<div class="righ_nav_content">
    <!-- Contact module -->
    <div class="righ_nav_users search-box padding-0 col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="padding-0 col-xs-2 col-sm-2 col-md-2 col-lg-2">
            <button onclick="add_new_contact(this)" class="success round s margin-0">
                <span class="material-icons">person_add</span>
            </button>
        </div>
        <div id="cart_user_input_dropdown"
            class="dropdown-auto-subjet-body padding-0 col-xs-8 col-sm-8 col-md-8 col-lg-8 ">
            <input autocomplete="off" id="cart_user_input" class="form-control" type="text"
                placeholder="{{#with ws_lang_data}} {{input_contact_search}} {{/with}}">
            <ul id="contact_auto_subjet" class="">

            </ul>
        </div>
        <div class="text-right padding-0 col-xs-2 col-sm-2 col-md-2 col-lg-2">
            <div class="btn-group dropright">
                <button type="button" class="success round s margin-0 dropdown-toggle dropdown-toggle-split"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                    <div class="round-icon pr">
                        <span id="select_price_list_cart" price_list_id="" price_list_value=""> m </span>
                    </div>

                </button>
                <ul class="dropdown-menu pull-right">

                    <li class="header">Listas de precios</li>
                    {{#each price_doc.price_list}}
                    <li>
                        <a href="#">
                            <div class="round-icon user-top"><span> {{value}} </span></div> {{value}}
                        </a>
                    </li>
                    {{/each}}

                </ul>
            </div>
        </div>
    </div>
    <!-- Product module -->
    {{#ifEquals board_type_name 'purcharse'}}{{/ifEquals}}
    <!-- Cart main module -->
    <div class="tabs-main margin-t-30 default col-xs-12 col-sm-12 col-md-12 col-lg-12 padding-t-30">
        <ul class="nav nav-tabs">

            <li id="product_order_item_tab_icon" class="ripple  active">

                <a data-toggle="tab" href="#product_order_items_tab">
                    <span class="material-icons">{{#with ws_lang_data}} {{b_order_items_icon}} {{/with}}</span>
                    <span class="order_items_n cart-number">0</span>
                    <span class="hidden-xs">
                        {{#with ws_lang_data}} {{b_order_items}} {{/with}}
                    </span>
                </a>
            </li>
            <li id="_item_tab_icon" class="ripple">
                <a data-toggle="tab" href="#pay_items_tab">
                    <span class="material-icons"> {{#with ws_lang_data}} {{b_order_items_icon}} {{/with}}</span>
                    <span class="pay_items_n fav_count">0</span>
                    <span class="hidden-xs">
                        {{#with ws_lang_data}} {{b_order_pay_items}} {{/with}}
                    </span>
                </a>
            </li>
            <li id="_item_tab_icon" class="ripple">
                <a data-toggle="tab" href="#activity_item_tab">
                    <span class="material-icons"> {{#with ws_lang_data}} {{b_order_items_icon}} {{/with}} </span>
                    <span class="activity_items_n fav_count">0</span>
                    <span class="hidden-xs">
                        {{#with ws_lang_data}} {{b_order_activity_items}} {{/with}}
                    </span>
                </a>
            </li>
        </ul>
        <!--tab-content--->
        <div class="tab-content ">
            <!--tab--->
            <div id="product_order_item_tab" class="tab-pane fade in active">
                <div id="product_order_items" class="s-card-activ-cont gray">
                </div>
            </div>
            <div id="pay_item_tab" class="tab-pane fade in">
                <div id="service_order_items" class="s-card-activ-cont gray">
                </div>
            </div>
            <div id="activity_item_tab" class="tab-pane fade in">
                <div id="activity_new_product" class="s-card-activ-cont gray">
                </div>
            </div>
            <!--tab-content--->
        </div>
        <!--tabs-main--->
    </div>

</div>


<!-- Cart footer module -->
<div id="cart_footer">
    <div class="righ_nav_footer_main cart_drop_up">
        <div class="s-card-activ-footer ">
            <div id="cart_total_items">
                <div class="panel-group " id="accordion" role="tablist" aria-multiselectable="true">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="headingOne">
                            <h4 class="panel-title">
                                <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne"
                                    aria-expanded="true" aria-controls="collapseOne">
                                    <div class="row">
                                        <h3 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-left">
                                            {{#with ws_lang_data}} {{t_total}}{{/with}}
                                        </h3>
                                        <span class="drop-up-total-cart">
                                            <span class="material-icons">
                                                keyboard_double_arrow_up
                                            </span>
                                        </span>
                                        <h3 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-right">
                                            {{#with ws_info}} {{money}}{{/with}}
                                            <span id="total_cart_neto">
                                                0
                                            </span>
                                        </h3>
                                    </div>
                                </a>
                            </h4>
                        </div>
                        <div id="collapseOne" class="panel-collapse collapse" role="tabpanel"
                            aria-labelledby="headingOne">
                            <div class="panel-body">
                                <div class="row">
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-left">
                                        {{#with ws_lang_data}} {{t_service}}{{/with}}:
                                    </h4>
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-right">
                                        {{#with ws_info}} {{money}}{{/with}}
                                        <span id="total_neto_service">0</span>
                                    </h4>
                                </div>
                                <div class="row ">
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-left">
                                        {{#with ws_lang_data}} {{t_product}}{{/with}}:
                                    </h4>
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-right">
                                        {{#with ws_info}} {{money}}{{/with}}
                                        <span id="total_neto_prod">0</span>
                                    </h4>
                                </div>
                                <div class="row text-red">
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-left">
                                        {{#with ws_lang_data}} {{t_dicount}}{{/with}}:
                                    </h4>
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-right">
                                        {{#with ws_info}} {{money}}{{/with}}
                                        <span id="total_neto_discount">0</span>
                                    </h4>
                                </div>
                                <div class="row text-red">
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-left">
                                        {{#with ws_lang_data}} {{t_tax}}{{/with}}

                                    </h4>
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-right">
                                        {{#with ws_info}} {{#each tax}} {{tax_name}} (% {{tax_value}})
                                        {{/each}}{{/with}}
                                        <span id="total_neto_tax">0</span>
                                    </h4>
                                </div>
                                <div class="row text-green">
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-left">
                                        {{#with ws_lang_data}} {{t_pay}}{{/with}}:

                                    </h4>
                                    <h4 class="col-xs-6 col-sm-6 col-md-6 col-lg-6 text-right">
                                        {{#with ws_info_}} {{money}}{{/with}}:
                                        <span id="total_neto_pay">0</span>
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--button type="button" class="btn btn-primary"><span class="material-icons"> print </span> Imprimir </button-->
        <button id="cart_button_new_order" onclick="new_order(this)" category_id="{{board_type_name}}" type="button"
            class="margin-top cobrar-btn btn btn-primary btn-full-with">
            <span class="material-icons">monetization_on</span>
            {{#with ws_lang_data}} {{b_add_order}}{{/with}}
        </button>
    </div>
</div>


<script>
    // Este es tu método de búsqueda asíncrono

    async function select_contact(element) {

        try {
            let _id = $(element).attr('contact_id');
            contact_doc = await L_contact_db.get(_id, { include_docs: true, descending: true });
            price_list_id = contact_doc.price_list
            price_list_doc = await L_catalog_db.get('price_list', { include_docs: true, descending: true });
            // console.log('_id',_id)  
            // console.log('contact_doc',contact_doc)     
            // console.log('price_list_id',price_list_id)      
            // console.log('price_list_doc',price_list_doc)        
            const price_select = price_list_doc.price_list.find(element => element.id == price_list_id);
            //  console.log('price_select',price_select) 
            $('#cart_user_input').attr('contact_id', contact_doc._id);
            $('#cart_user_input').val(contact_doc.first_name + " " + contact_doc.last_name);
            $('#select_price_list_cart').attr('contact_id', contact_doc.price_list);
            $('#select_price_list_cart').attr('contact_id', price_list_doc.price_list);
            $('#cart_button_new_order').attr('contact_id', _id);
            const price_select_letra = price_select.value[0];
            $('#select_price_list_cart').text(price_select_letra);
            $('#contact_auto_subjet').removeClass('open');

        } catch (error) {
            // Muestra el error en un Snackbar
            Snackbar.show({
                text: 'Error select_contact ' + error.message,
                actionText: 'ok',
                actionTextColor: "#0575e6",
            });
        }
    }

    async function searchContacts(query) {
        try {
            const contact_search_options = {
                includeScore: true,
                keys: ['first_name', 'last_name', 'document_number', 'phone']
            };
            let contact_search_fuse;
            // Obtén todos los documentos que comienzan con 'contact_'
            const allDocs = await L_contact_db.allDocs({
                include_docs: true,
                startkey: 'contact_',
                endkey: 'contact_\ufff0'
            });
            // Crea una nueva instancia de Fuse con los documentos obtenido
            contact_search_fuse = new Fuse(allDocs.rows.map(row => row.doc), contact_search_options);
            // Haz la búsqueda con Fuse
            const searchResults = contact_search_fuse.search(query);
            const data = { user_data: searchResults.map(result => result.item) };

            if (searchResults.length > 0) {
                renderHandlebarsTemplate('/public/app/v4.0/dist/hbs/workspace/contact/subjet_contact_list.hbs', '#contact_auto_subjet', data);
            } else {
                $('#contact_auto_subjet').html('<h4 class="padding-10 text-center" >Sin resultados... </h4>');
            }


            console.log('DATA', data);
        } catch (err) {
            console.log('searchContacts', err);
            // Muestra el error en un Snackbar
            Snackbar.show({
                text: 'Hubo un error en la búsqueda: ' + err,
                actionText: 'ok',
                actionTextColor: "#0575e6",
            });
        }
    }


    async function edit_order_contact(element) {
        try {
            const modal = document.getElementById('master_popup');
            const doc_id = $(element).attr('doc_id'); //Id del documento a editar
            // const rev_id = $(element).attr('rev_id'); //Id del documento a editar
            // Listas de precio ws_collections_333433/
            ws_price_list = await L_catalog_db.get('price_list', { include_docs: true, descending: true });
            doc = await L_contact_db.get(doc_id, { include_docs: true, descending: true });
            const data = {
                ws_price_list: ws_price_list,
                ws_info: ws_info,
                ws_lang_data: ws_lang_data,
                user_roles: user_Ctx.userCtx.roles,
                doc: doc
            }

            console.log(data);
            $(modal).modal('show');
            renderHandlebarsTemplate('/public/app/v4.0/dist/hbs/workspace/contact/popup/edit_contact.hbs', '#master_popup', data);
            // save_new_conctact();
        } catch (err) {
            console.log('ERROR add_new_contact', err)
            Snackbar.show({
                text: err.reason,
                actionText: '<span class="material-icons">refresh</span> Refresh ',
                actionTextColor: "#0575e6",
                //  duration: Snackbar.LENGTH_INDEFINITE,
                //   action: () => { updateDocuments() }
            });
        }
    }

    // FUNCIONES 2023 aparece auto subjet
    $('#cart_user_input').on('focusin', function () {
        $('#contact_auto_subjet').addClass('open');
    });
    $('#contact_auto_subjet').on('click', function (event) {
        event.stopPropagation();
    });
    $(document).on('click focusout', function (event) {
        if (!$(event.target).closest('#contact_auto_subjet').length && !$(event.target).is('#cart_user_input')) {
            if (!$(event.target).is('#cart_button_new_order')) {
                $('#contact_auto_subjet').removeClass('open');
            }
        }
    });

    $('#cart_user_input').on('keyup', function (event) {
        const value = event.target.value;
        searchContacts(value);
    });


</script>